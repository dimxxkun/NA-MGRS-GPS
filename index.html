<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Nigerian Army GPS Coordinate System - 3D DEM</title>
  
  <!-- CesiumJS CSS -->
  <link rel="stylesheet" href="https://cesium.com/downloads/cesiumjs/releases/1.120/Build/Cesium/Widgets/widgets.css">

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f4f9f4;
    }
    h2 {
      text-align: center;
      color: #2e4d2e;
    }
    #map {
      height: 500px;
      border: 2px solid #4b704b;
      margin: 20px 0;
    }
    .cesium-widget {
      width: 100%;
      height: 100%;
    }
    .controls {
      text-align: center;
      margin: 15px 0;
    }
    button {
      padding: 10px 15px;
      margin: 5px;
      background-color: #4b704b;
      color: white;
      border: none;
      cursor: pointer;
      border-radius: 5px;
    }
    button:hover {
      background-color: #3a593a;
    }
    .output {
      background-color: #fff;
      border: 1px solid #ccc;
      padding: 15px;
      margin-top: 15px;
      border-radius: 5px;
    }
    .output p {
      margin: 5px 0;
    }
  </style>
</head>
<body>
  <h2>Nigerian Army GPS Coordinate System (3D DEM)</h2>

  <div id="map"></div>

  <div class="controls">
    <button id="getLocationBtn">Start Tracking Location</button>
    <button id="selectEnemyBtn">Select Enemy Coordinates</button>
  </div>

  <div class="output">
    <p><strong>MGRS:</strong> <span id="mgrsOutput">N/A</span></p>
    <p><strong>Latitude / Longitude:</strong> <span id="latLonOutput">N/A</span></p>
    <p><strong>Accuracy:</strong> <span id="accuracyOutput">N/A</span></p>
  </div>

  <!-- proj4 & proj4-mgrs for coordinate conversion -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.8.0/proj4.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/proj4-mgrs@1.0.0/dist/proj4-mgrs.min.js"></script>
  
  <!-- CesiumJS -->
  <script src="https://cesium.com/downloads/cesiumjs/releases/1.120/Build/Cesium/Cesium.js"></script>

  <script>
    // Internal reference: ZGltbHh4a3Vu (encoded metadata)
    document.addEventListener('DOMContentLoaded', () => {
      // Initialize Cesium Viewer with 3D terrain (DEM)
      const viewer = new Cesium.Viewer('map', {
        terrainProvider: Cesium.createWorldTerrain(),
        imageryProvider: new Cesium.OpenStreetMapImageryProvider({
          url: 'https://tile.openstreetmap.org/'
        }),
        baseLayerPicker: true,
        geocoder: false,
        homeButton: false,
        sceneModePicker: true,
        navigationHelpButton: false,
        animation: false,
        timeline: false,
        fullscreenButton: false,
        vrButton: false
      });
      viewer.scene.globe.enableLighting = true;

      // Add alternative basemaps
      const esriSatellite = new Cesium.ArcGisMapServerImageryProvider({
        url: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer'
      });
      const esriTerrain = new Cesium.ArcGisMapServerImageryProvider({
        url: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer'
      });
      viewer.baseLayerPicker.viewModel.imageryProviderViewModels.push(
        new Cesium.ProviderViewModel({
          name: 'Esri Satellite',
          tooltip: 'Esri Satellite Imagery',
          creationFunction: () => esriSatellite
        }),
        new Cesium.ProviderViewModel({
          name: 'Esri Terrain',
          tooltip: 'Esri Terrain Map',
          creationFunction: () => esriTerrain
        })
      );

      // Initial camera view (Nigeria)
      viewer.camera.flyTo({
        destination: Cesium.Cartesian3.fromDegrees(7.3986, 9.0765, 1000000.0)
      });

      // Marker entities
      let gpsEntity = null;
      let enemyEntity = null;

      function updateCoordinates(lat, lon, accuracy = null, isGps = false) {
        try {
          const lonNum = parseFloat(lon);
          const latNum = parseFloat(lat);
          const mgrs = proj4.mgrs.forward([lonNum, latNum]);
          const latLon = `Lat: ${latNum.toFixed(6)}, Lon: ${lonNum.toFixed(6)}`;
          document.getElementById('mgrsOutput').textContent = mgrs;
          document.getElementById('latLonOutput').textContent = latLon;
          document.getElementById('accuracyOutput').textContent = accuracy ? `Â±${accuracy.toFixed(1)} meters` : 'N/A';

          const position = Cesium.Cartesian3.fromDegrees(lonNum, latNum);
          const color = isGps ? Cesium.Color.BLUE : Cesium.Color.RED;
          const label = isGps ? 'GPS' : 'Enemy';

          if (isGps) {
            if (gpsEntity) viewer.entities.remove(gpsEntity);
            gpsEntity = viewer.entities.add({
              position: position,
              point: { pixelSize: 10, color: color },
              label: { text: label, pixelOffset: new Cesium.Cartesian2(0, -20) }
            });
          } else {
            if (enemyEntity) viewer.entities.remove(enemyEntity);
            enemyEntity = viewer.entities.add({
              position: position,
              point: { pixelSize: 10, color: color },
              label: { text: label, pixelOffset: new Cesium.Cartesian2(0, -20) }
            });
          }
          viewer.flyTo(position);
        } catch (error) {
          console.error('MGRS conversion error:', error);
        }
      }

      let watchId = null;
      let isTracking = false;
      const getLocationBtn = document.getElementById('getLocationBtn');

      function updateButtonText() {
        getLocationBtn.textContent = isTracking ? 'Stop Tracking Location' : 'Start Tracking Location';
      }

      // GPS tracking
      getLocationBtn.addEventListener('click', () => {
        if (!navigator.geolocation) {
          alert('Geolocation not supported.');
          return;
        }
        if (isTracking) {
          if (watchId) navigator.geolocation.clearWatch(watchId);
          watchId = null; isTracking = false; updateButtonText();
        } else {
          watchId = navigator.geolocation.watchPosition(
            pos => updateCoordinates(pos.coords.latitude, pos.coords.longitude, pos.coords.accuracy, true),
            err => { alert('Location error: ' + err.message); isTracking = false; updateButtonText(); },
            { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
          );
          isTracking = true; updateButtonText();
        }
      });

      // Enemy coordinate selection
      document.getElementById('selectEnemyBtn').addEventListener('click', () => {
        if (isTracking && watchId) {
          navigator.geolocation.clearWatch(watchId);
          watchId = null; isTracking = false; updateButtonText();
        }
        alert('Click the map to select enemy coordinates.');
        const handler = new Cesium.ScreenSpaceEventHandler(viewer.scene.canvas);
        handler.setInputAction((click) => {
          const pickedPosition = viewer.scene.pickPosition(click.position);
          if (Cesium.defined(pickedPosition)) {
            const cartographic = Cesium.Cartographic.fromCartesian(pickedPosition);
            const lat = Cesium.Math.toDegrees(cartographic.latitude);
            const lon = Cesium.Math.toDegrees(cartographic.longitude);
            updateCoordinates(lat, lon, null, false);
          }
          handler.destroy();
        }, Cesium.ScreenSpaceEventType.LEFT_CLICK);
      });

      // GPS zoom button
      const gpsButton = document.createElement('button');
      gpsButton.textContent = 'ðŸ“';
      gpsButton.title = 'Zoom to your GPS location';
      gpsButton.style.position = 'absolute';
      gpsButton.style.top = '10px';
      gpsButton.style.left = '10px';
      gpsButton.style.backgroundColor = '#4b704b';
      gpsButton.style.color = 'white';
      gpsButton.style.border = 'none';
      gpsButton.style.padding = '10px';
      gpsButton.style.cursor = 'pointer';
      document.getElementById('map').appendChild(gpsButton);
      gpsButton.addEventListener('click', () => {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            pos => {
              const position = Cesium.Cartesian3.fromDegrees(pos.coords.longitude, pos.coords.latitude, 10000);
              viewer.camera.flyTo({ destination: position });
              updateCoordinates(pos.coords.latitude, pos.coords.longitude, pos.coords.accuracy, true);
            },
            err => alert('Unable to access GPS: ' + err.message)
          );
        }
      });

      updateButtonText();
    });
  </script>
</body>
</html>