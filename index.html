<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Nigerian Army GPS Coordinate System</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    body { margin:0; font-family:Arial, sans-serif; }
    #map { height: 70vh; width: 100%; }
    .controls { padding:10px; background:#f4f4f4; }
    .controls button { margin:5px; padding:8px 12px; border:none; border-radius:6px; cursor:pointer; }
    .controls button:hover { background:#ddd; }
    .output { padding:10px; background:#fafafa; border-top:1px solid #ccc; }
    .output div { margin:4px 0; }
    .copy-btn { margin-left:10px; padding:3px 6px; cursor:pointer; border:1px solid #ccc; border-radius:4px; }
    #errorOutput { color:red; font-weight:bold; margin-top:5px; }
    .picking-mode { cursor: crosshair; }
    .leaflet-control-custom:hover { background:#3a563a !important; }
  </style>
</head>
<body>

  <div id="map"></div>

  <div class="controls">
    <button id="getLocationBtn">Start Tracking Location</button>
    <button id="selectEnemyBtn">Select Enemy Location</button>
    <div id="errorOutput"></div>
  </div>

  <div class="output">
    <div>MGRS: <span id="mgrsOutput">N/A</span> <button class="copy-btn" data-target="mgrsOutput">Copy</button></div>
    <div>Lat/Lon: <span id="latLonOutput">N/A</span> <button class="copy-btn" data-target="latLonOutput">Copy</button></div>
    <div>Accuracy: <span id="accuracyOutput">N/A</span></div>
    <div>Last Updated: <span id="timestampOutput">N/A</span></div>
  </div>

  <!-- Leaflet + Proj4JS + MGRS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.8.1/proj4.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.8.1/mgrs.min.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
        // Initial map setup
        const savedView = localStorage.getItem('lastMapView');
        const defaultView = { lat: 9.0765, lng: 7.3986, zoom: 6 };
        const initialView = savedView ? JSON.parse(savedView) : defaultView;
        const map = L.map('map').setView([initialView.lat, initialView.lng], initialView.zoom);

        // Basemaps
        const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);
        const esriSatellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}');
        const esriTerrain = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}');
        const esriLabels = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}');
        L.control.layers({ "OpenStreetMap": osmLayer, "Satellite": esriSatellite, "Terrain": esriTerrain }, { "Labels": esriLabels }).addTo(map);

        // Save map view
        map.on('moveend', () => {
            const center = map.getCenter();
            localStorage.setItem('lastMapView', JSON.stringify({ lat: center.lat, lng: center.lng, zoom: map.getZoom() }));
        });

        // Icons
        const gpsIcon = new L.Icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',
            shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
            iconSize: [25,41], iconAnchor: [12,41]
        });
        const enemyIcon = new L.Icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
            shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
            iconSize: [25,41], iconAnchor: [12,41]
        });

        // Layers
        let gpsMarker = null;
        const enemyLayer = L.layerGroup().addTo(map);

        // Controls
        const getLocationBtn = document.getElementById('getLocationBtn');
        const errorOutput = document.getElementById('errorOutput');
        let watchId = null, isTracking = false, isPaused = false;

        // Helpers
        function updateButtonText() {
            getLocationBtn.textContent = isTracking ? (isPaused ? 'Resume Tracking' : 'Pause Tracking') : 'Start Tracking Location';
        }
        function setError(msg) { errorOutput.textContent = msg; setTimeout(()=> errorOutput.textContent='',4000); }
        function updateCoordinates(lat, lon, accuracy=null, isGps=false) {
            const mgrs = proj4.mgrs.forward([lon, lat]);
            document.getElementById('mgrsOutput').textContent = mgrs;
            document.getElementById('latLonOutput').textContent = `Lat: ${lat.toFixed(6)}, Lon: ${lon.toFixed(6)}`;
            document.getElementById('accuracyOutput').textContent = accuracy ? `±${accuracy.toFixed(1)}m` : 'N/A';
            document.getElementById('timestampOutput').textContent = new Date().toLocaleString();

            if(isGps) {
                if(gpsMarker) gpsMarker.setLatLng([lat,lon]);
                else gpsMarker = L.marker([lat,lon],{icon:gpsIcon}).addTo(map);
            } else {
                L.marker([lat,lon],{icon:enemyIcon}).addTo(enemyLayer);
            }
        }
        function startTracking() {
            watchId = navigator.geolocation.watchPosition(
                pos => updateCoordinates(pos.coords.latitude,pos.coords.longitude,pos.coords.accuracy,true),
                err => { setError('Location error: '+err.message); stopTracking(); },
                { enableHighAccuracy:true, timeout:10000, maximumAge:0 }
            );
            isTracking=true; isPaused=false; updateButtonText();
        }
        function stopTracking() {
            if(watchId) navigator.geolocation.clearWatch(watchId);
            watchId=null; isTracking=false; isPaused=false; updateButtonText();
        }

        // GPS tracking button
        getLocationBtn.addEventListener('click',()=>{
            if(!navigator.geolocation){ setError('Geolocation not supported'); return; }
            if(isTracking){ if(isPaused) startTracking(); else { navigator.geolocation.clearWatch(watchId); isPaused=true; updateButtonText(); } }
            else startTracking();
        });

        // Enemy marker button
        document.getElementById('selectEnemyBtn').addEventListener('click',()=>{
            stopTracking();
            map.getContainer().classList.add('picking-mode');
            setError('Click map to place enemy marker');
            map.once('click',e=>{
                updateCoordinates(e.latlng.lat,e.latlng.lng,null,false);
                map.getContainer().classList.remove('picking-mode');
            });
        });

        // Copy buttons
        document.querySelectorAll('.copy-btn').forEach(btn=>{
            btn.addEventListener('click',()=>{
                const target=document.getElementById(btn.dataset.target);
                navigator.clipboard.writeText(target.textContent).then(()=> setError('Copied!'));
            });
        });

        // 📍 Custom zoom-to-location control
        const gpsControl = L.Control.extend({
            options: { position: 'topleft' },
            onAdd: () => {
                const container = L.DomUtil.create('div', 'leaflet-bar leaflet-control leaflet-control-custom');
                container.innerHTML = '📍';
                container.title = 'Zoom to current GPS location';
                container.style.cssText = `
                    background:#4b704b; width:34px; height:34px; display:flex;
                    justify-content:center; align-items:center; cursor:pointer; font-size:18px; color:white;
                `;
                container.onclick = () => {
                    if (navigator.geolocation) {
                        navigator.geolocation.getCurrentPosition(
                            pos => {
                                const { latitude, longitude, accuracy } = pos.coords;
                                updateCoordinates(latitude, longitude, accuracy, true);
                                map.setView([latitude, longitude], 15);
                            },
                            err => setError('Unable to get GPS: ' + err.message)
                        );
                    } else setError('Geolocation not supported');
                };
                return container;
            }
        });
        map.addControl(new gpsControl());

        updateButtonText();
    });
  </script>
</body>
</html>