<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PF - GEOTRACE</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
  <style>
    body { margin: 0; font-family: Arial, sans-serif; background: #f4f4f9; }
    #map { height: 100vh; width: 100%; }
    .coordinate-box {
      position: absolute; bottom: 20px; left: 20px;
      background: white; padding: 15px; border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3); font-size: 14px;
      max-height: 300px; overflow-y: auto;
    }
    .coordinate-box h3 { margin-top: 0; font-size: 16px; }
    .copy-btn, #copyAllBtn, #exportBtn, #unitToggle {
      margin-top: 6px; padding: 5px 10px; font-size: 13px;
      background: #0078ff; color: white; border: none;
      border-radius: 4px; cursor: pointer;
    }
    .copy-btn:hover, #copyAllBtn:hover, #exportBtn:hover, #unitToggle:hover {
      background: #005fcc;
    }
    #controls {
      position: absolute; top: 20px; right: 20px;
      background: white; padding: 10px; border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      display: flex; flex-direction: column; gap: 6px;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="controls">
    <button id="unitToggle">Switch to Miles</button>
    <button id="exportBtn">Export to CSV</button>
    <button id="copyAllBtn">Copy All</button>
  </div>
  <div class="coordinate-box" id="coordinateBox">
    <h3>Coordinates</h3>
    <div id="outputs"></div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.9.2/proj4.js"></script>
  <script src="https://unpkg.com/mgrs@1.0.0/mgrs.js"></script>
  <script>
    // Initialize map
    const map = L.map('map').setView([9.082, 8.6753], 6);

    // Basemaps
    const baseMaps = {
      "OpenStreetMap": L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"),
      "Esri Satellite": L.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}"),
      "OpenTopoMap": L.tileLayer("https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png")
    };
    baseMaps["OpenStreetMap"].addTo(map);
    L.control.layers(baseMaps).addTo(map);

    // Geocoder
    L.Control.geocoder({ defaultMarkGeocode: true }).addTo(map);

    // Coordinate outputs
    function toDMS(deg, type) {
      let d = Math.floor(Math.abs(deg));
      let m = Math.floor((Math.abs(deg) - d) * 60);
      let s = (((Math.abs(deg) - d) * 60 - m) * 60).toFixed(2);
      let dir = deg >= 0 ? (type === 'lat' ? 'N' : 'E') : (type === 'lat' ? 'S' : 'W');
      return `${d}Â°${m}'${s}"${dir}`;
    }

    function updateCoordinates(lat, lng) {
      const mgrsCoord = mgrs.forward([lng, lat]);
      const dms = `${toDMS(lat,'lat')}, ${toDMS(lng,'lng')}`;
      const utm = proj4('+proj=utm +zone=32 +datum=WGS84').forward([lng, lat]).map(x=>x.toFixed(2)).join(', ');
      const outputs = document.getElementById('outputs');
      outputs.innerHTML = `
        <div><b>Lat/Lon:</b> ${lat.toFixed(6)}, ${lng.toFixed(6)} <button class="copy-btn" onclick="copyText('${lat.toFixed(6)}, ${lng.toFixed(6)}')">Copy</button></div>
        <div><b>DMS:</b> ${dms} <button class="copy-btn" onclick="copyText('${dms}')">Copy</button></div>
        <div><b>MGRS:</b> ${mgrsCoord} <button class="copy-btn" onclick="copyText('${mgrsCoord}')">Copy</button></div>
        <div><b>UTM:</b> ${utm} <button class="copy-btn" onclick="copyText('${utm}')">Copy</button></div>
      `;
    }

    function copyText(text) {
      navigator.clipboard.writeText(text);
    }

    // Click event
    map.on('click', (e) => {
      updateCoordinates(e.latlng.lat, e.latlng.lng);
    });

    // Copy All button
    document.getElementById('copyAllBtn').addEventListener('click', () => {
      const text = document.getElementById('outputs').innerText;
      navigator.clipboard.writeText(text);
      alert("All coordinates copied!");
    });

    // Export CSV
    document.getElementById('exportBtn').addEventListener('click', () => {
      const text = document.getElementById('outputs').innerText.replace(/\n/g, ", ");
      const csvContent = "data:text/csv;charset=utf-8," + text;
      const link = document.createElement("a");
      link.setAttribute("href", encodeURI(csvContent));
      link.setAttribute("download", "coordinates.csv");
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    });

  </script>
</body>
</html>